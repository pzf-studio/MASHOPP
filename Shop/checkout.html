<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ - MA Furniture</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="shop.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <a href="../index.html">
                        <div class="logo-container">
                            <img src="../images/logo2.png" alt="MA Furniture" class="logo-image">
                            <div class="logo-text-container">
                                <span class="logo-text">MA FURNITURE</span>
                            </div>
                        </div>
                    </a>
                </div>
                
                <nav class="main-nav">
                    <ul>
                        <li><a href="../index.html">–ì–ª–∞–≤–Ω–∞—è</a></li>
                        <li><a href="shop.html">–ö–∞—Ç–∞–ª–æ–≥</a></li>
                        <li><a href="../index.html#about">–û –∫–æ–º–ø–∞–Ω–∏–∏</a></li>
                        <li><a href="../index.html#faq">FAQ</a></li>
                    </ul>
                </nav>
                
                <div class="header-actions">
                    <a href="https://t.me/Ma_Furniture_ru" class="btn btn-outline btn-telegram">
                        <i class="fab fa-telegram-plane"></i>
                        <span>Telegram</span>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <section class="checkout">
        <div class="container">
            <h1 class="checkout-title">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h1>
            
            <div class="checkout-content">
                <div class="checkout-form">
                    <h2 class="form-title">–î–∞–Ω–Ω—ã–µ –¥–ª—è –∑–∞–∫–∞–∑–∞</h2>
                    <form id="orderForm">
                        <div class="form-group">
                            <label for="customerName" class="form-label">–§–ò–û *</label>
                            <input type="text" id="customerName" class="form-input" required placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á">
                        </div>
                        
                        <div class="form-group">
                            <label for="customerEmail" class="form-label">Email *</label>
                            <input type="email" id="customerEmail" class="form-input" required placeholder="example@mail.ru">
                        </div>
                        
                        <div class="form-group">
                            <label for="customerPhone" class="form-label">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ *</label>
                            <input type="tel" id="customerPhone" class="form-input" required placeholder="+7 (900) 123-45-67">
                        </div>
                        
                        <div class="form-group">
                            <label for="preferredMessenger" class="form-label">–ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º—ã–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</label>
                            <select id="preferredMessenger" class="form-select">
                                <option value="telegram">Telegram</option>
                                <option value="whatsapp">WhatsApp</option>
                                <option value="phone">–¢–µ–ª–µ—Ñ–æ–Ω–Ω—ã–π –∑–≤–æ–Ω–æ–∫</option>
                                <option value="email">Email</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="orderComment" class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É</label>
                            <textarea id="orderComment" class="form-textarea" placeholder="–í–∞—à–∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è –∏–ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..."></textarea>
                        </div>
                        
                        <div class="form-actions">
                            <a href="shop.html" class="btn btn-back">
                                <i class="fas fa-arrow-left"></i>
                                –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–∞–≥–∞–∑–∏–Ω
                            </a>
                            <button type="submit" class="btn btn-submit" id="submitOrder">
                                <i class="fas fa-paper-plane"></i>
                                –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑
                            </button>
                        </div>
                    </form>
                </div>
                <div class="order-summary">
                    <h2 class="summary-title">–í–∞—à –∑–∞–∫–∞–∑</h2>                 
                    <div class="summary-items" id="orderItems">
                    </div>                  
                    <div class="summary-totals">
                        <div class="total-row">
                            <span>–¢–æ–≤–∞—Ä—ã:</span>
                            <span id="subtotalAmount">0 ‚ÇΩ</span>
                        </div>
                        <div class="total-row">
                            <span>–î–æ—Å—Ç–∞–≤–∫–∞:</span>
                            <span>–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º</span>
                        </div>
                        <div class="total-row final">
                            <span>–ò—Ç–æ–≥–æ:</span>
                            <span id="totalAmount">0 ‚ÇΩ</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <footer class="main-footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>MA Furniture</h3>
                    <p>–≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ –≥–∞—Ä–¥–µ—Ä–æ–±–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã –ø—Ä–µ–º–∏—É–º-–∫–ª–∞—Å—Å–∞ —Å –∏—Ç–∞–ª—å—è–Ω—Å–∫–∏–º –¥–∏–∑–∞–π–Ω–æ–º –∏ –Ω–µ–º–µ—Ü–∫–æ–π —Ç–æ—á–Ω–æ—Å—Ç—å—é.</p>
                    <div class="social-links">
                        <a href="https://t.me/Ma_Furniture_ru" aria-label="Telegram">
                            <i class="fab fa-telegram-plane"></i>
                        </a>
                        <a href="#" aria-label="Instagram">
                            <i class="fab fa-instagram"></i>
                        </a>
                        <a href="#" aria-label="WhatsApp">
                            <i class="fab fa-whatsapp"></i>
                        </a>
                    </div>
                </div> 
                <div class="footer-section">
                    <h4>–ù–∞–≤–∏–≥–∞—Ü–∏—è</h4>
                    <ul>
                        <li><a href="../index.html">–ì–ª–∞–≤–Ω–∞—è</a></li>
                        <li><a href="../index.html#about">–û –∫–æ–º–ø–∞–Ω–∏–∏</a></li>
                        <li><a href="shop.html">–ú–∞–≥–∞–∑–∏–Ω</a></li>
                        <li><a href="../index.html#faq">FAQ</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h4>
                    <ul>
                        <li><a href="shop.html?category=pantograph">–ü–∞–Ω—Ç–æ–≥—Ä–∞—Ñ—ã</a></li>
                        <li><a href="shop.html?category=wardrobe">–ì–∞—Ä–¥–µ—Ä–æ–±–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã</a></li>
                        <li><a href="shop.html?category=premium">–ü—Ä–µ–º–∏—É–º –∫–æ–ª–ª–µ–∫—Ü–∏—è</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>–ö–æ–Ω—Ç–∞–∫—Ç—ã</h4>
                    <ul>
                        <li><i class="fas fa-phone"></i> +7 (910) 005-34-24</li>
                        <li><i class="fas fa-envelope"></i> ma.furniture@mail.ru</li>
                        <li><i class="fas fa-map-marker-alt"></i> –ú–æ—Å–∫–≤–∞, –†–æ—Å—Å–∏—è</li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2023 MA Furniture. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
            </div>
        </div>
    </footer>
    <script>
        class CheckoutSystem {
            constructor() {
                this.cart = this.loadCart();
                this.init();
            }

            init() {
                this.renderOrderSummary();
                this.setupEventListeners();
                this.setupCartSync();
            }

            loadCart() {
                if (typeof getCartData === 'function') {
                    return getCartData();
                }
                try {
                    return JSON.parse(localStorage.getItem('ma_furniture_cart')) || [];
                } catch (error) {
                    console.error('Error loading cart:', error);
                    return [];
                }
            }

            setupCartSync() {
                window.addEventListener('storage', (e) => {
                    if (e.key === 'ma_furniture_cart') {
                        console.log('–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã –≤ localStorage');
                        this.cart = this.loadCart();
                        this.renderOrderSummary();
                    }
                });

                window.addEventListener('cartUpdated', (e) => {
                    console.log('–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ—Ä–∑–∏–Ω—ã');
                    this.cart = (e.detail && e.detail.cart) ? e.detail.cart : this.loadCart();
                    this.renderOrderSummary();
                });

                setTimeout(() => {
                    this.cart = this.loadCart();
                    this.renderOrderSummary();
                }, 100);
            }

            renderOrderSummary() {
                const itemsContainer = document.getElementById('orderItems');
                const subtotalElement = document.getElementById('subtotalAmount');
                const totalElement = document.getElementById('totalAmount');
                const submitBtn = document.getElementById('submitOrder');

                if (!itemsContainer || !subtotalElement || !totalElement) {
                    console.error('Required elements not found');
                    return;
                }

                if (this.cart.length === 0) {
                    itemsContainer.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-shopping-cart"></i>
                            <h3>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</h3>
                            <p>–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞</p>
                            <a href="shop.html" class="btn btn-primary">–ü–µ—Ä–µ–π—Ç–∏ –≤ –º–∞–≥–∞–∑–∏–Ω</a>
                        </div>
                    `;
                    subtotalElement.textContent = '0 ‚ÇΩ';
                    totalElement.textContent = '0 ‚ÇΩ';
                    if (submitBtn) {
                        submitBtn.disabled = true;
                    }
                    return;
                }

                itemsContainer.innerHTML = this.cart.map(item => `
                    <div class="summary-item">
                        <div class="item-info">
                            <div class="item-details">
                                <div class="item-name">${item.name}</div>
                                <div class="item-price">${this.formatPrice(item.price)}</div>
                                <div class="item-quantity">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${item.quantity}</div>
                            </div>
                        </div>
                        <div class="item-total">${this.formatPrice(item.price * item.quantity)}</div>
                    </div>
                `).join('');

                const subtotal = this.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                subtotalElement.textContent = this.formatPrice(subtotal);
                totalElement.textContent = this.formatPrice(subtotal);
                
                if (submitBtn) {
                    submitBtn.disabled = false;
                }
            }

            setupEventListeners() {
                const form = document.getElementById('orderForm');
                const submitBtn = document.getElementById('submitOrder');

                if (!form || !submitBtn) {
                    console.error('Form or submit button not found');
                    return;
                }

                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.submitOrder();
                });

                form.addEventListener('input', () => {
                    const isValid = form.checkValidity();
                    const hasItems = this.cart.length > 0;
                    submitBtn.disabled = !isValid || !hasItems;
                });

                submitBtn.disabled = this.cart.length === 0;
            }

            async submitOrder() {
                const submitBtn = document.getElementById('submitOrder');
                if (!submitBtn) {
                    console.error('Submit button not found');
                    return;
                }

                const originalText = submitBtn.innerHTML;
                
                submitBtn.disabled = true;
                submitBtn.classList.add('loading');

                try {
                    const formData = {
                        name: document.getElementById('customerName').value,
                        email: document.getElementById('customerEmail').value,
                        phone: document.getElementById('customerPhone').value,
                        messenger: document.getElementById('preferredMessenger').value,
                        comment: document.getElementById('orderComment').value,
                        items: this.cart,
                        total: this.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                        timestamp: new Date().toLocaleString('ru-RU')
                    };

                    const message = this.formatTelegramMessage(formData);
                    
                    const encodedMessage = encodeURIComponent(message);
                    
                    const telegramUrl = `https://t.me/Ma_Furniture_ru?text=${encodedMessage}`;
                    
                    setTimeout(() => {
                        submitBtn.classList.remove('loading');
                        submitBtn.innerHTML = originalText;
                        
                        this.showNotification('–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω! –û—Ç–∫—Ä—ã–≤–∞–µ–º Telegram...', 'success');
                        
                        this.clearCart();
                        
                        window.open(telegramUrl, '_blank');
                        
                        setTimeout(() => {
                            window.location.href = '../index.html';
                        }, 3000);
                        
                    }, 1500);

                } catch (error) {
                    console.error('Order submission error:', error);
                    if (submitBtn) {
                        submitBtn.classList.remove('loading');
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    }
                    
                    this.showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.', 'error');
                }
            }

            clearCart() {
                if (typeof clearCart === 'function') {
                    clearCart();
                } else {
                    try {
                        localStorage.removeItem('ma_furniture_cart');
                    } catch (error) {
                        console.error('Error clearing cart:', error);
                    }
                }
                this.cart = [];
            }

            formatTelegramMessage(formData) {
                const messengerNames = {
                    'telegram': 'Telegram',
                    'whatsapp': 'WhatsApp', 
                    'viber': 'Viber',
                    'phone': '–¢–µ–ª–µ—Ñ–æ–Ω–Ω—ã–π –∑–≤–æ–Ω–æ–∫',
                    'email': 'Email'
                };

                let message = 'üõí –ù–û–í–´–ô –ó–ê–ö–ê–ó MA FURNITURE\n\n';
                message += 'üìÖ ' + formData.timestamp + '\n\n';
                
                message += 'üë§ –ö–õ–ò–ï–ù–¢:\n';
                message += '‚Ä¢ –§–ò–û: ' + formData.name + '\n';
                message += '‚Ä¢ Email: ' + formData.email + '\n';
                message += '‚Ä¢ –¢–µ–ª–µ—Ñ–æ–Ω: ' + formData.phone + '\n';
                message += '‚Ä¢ –ü—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–± —Å–≤—è–∑–∏: ' + (messengerNames[formData.messenger] || formData.messenger) + '\n\n';
                
                if (formData.comment) {
                    message += 'üí¨ –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ô –ö–õ–ò–ï–ù–¢–ê:\n' + formData.comment + '\n\n';
                }
                
                message += 'üõçÔ∏è –°–û–°–¢–ê–í –ó–ê–ö–ê–ó–ê:\n';
                formData.items.forEach((item, index) => {
                    message += (index + 1) + '. ' + item.name + '\n';
                    message += '   –ö–æ–ª-–≤–æ: ' + item.quantity + ' —à—Ç.\n';
                    message += '   –¶–µ–Ω–∞: ' + this.formatPrice(item.price) + ' √ó ' + item.quantity + ' = ' + this.formatPrice(item.price * item.quantity) + '\n\n';
                });
                
                message += 'üí∞ –ò–¢–û–ì–û: ' + this.formatPrice(formData.total) + '\n\n';
                message += 'üìç –î–û–°–¢–ê–í–ö–ê: —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º\n\n';
                message += '‚ö° –ó–∞–∫–∞–∑ —Ç—Ä–µ–±—É–µ—Ç –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏!';

                return message;
            }

            formatPrice(price) {
                return new Intl.NumberFormat('ru-RU', {
                    style: 'currency',
                    currency: 'RUB',
                    minimumFractionDigits: 0
                }).format(price);
            }

            showNotification(message, type = 'success') {
                const notification = document.createElement('div');
                notification.className = 'notification ' + type;
                notification.innerHTML = `
                    <div class="notification-content">
                        <i class="fas fa-${type === 'success' ? 'check' : 'exclamation'}-circle"></i>
                        ${message}
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.classList.add('show');
                }, 100);
                
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new CheckoutSystem();
        });
    </script>
    <script src="../Utils/image-manager.js"></script>
</body>
</html>